policies:

# Instances
- name: mark-unknown-instances-for-deletion
  resource: aws.ec2
  description: |
    Mark unknown user instances for deletion in 1 day
  filters:
    - "State.Name": running
    # instance name not in accepted user keys
    - type: value
      key: tag:Name
      op: regex
      #doesNOTcontain
      value:  "^((?!USERKEYS).)*$"
    # instance is not doNotDelete
    - 'tag:doNotDelete': absent
    - 'tag:DoNotDelete': absent
    - 'tag:ec2_known_user': absent
    - "tag:DeletesOnFriday": absent
    - "tag:ec2_unknown_user": absent
    - not: 
      - type: value
        key: tag:Name
        op: regex
        value:  "^.*DONOTDELETEKEYS.*$"
  actions:
    - type: mark-for-op
      tag: ec2_unknown_user
      op: terminate
      days: 1

- name: mark-known-instances-for-deletion
  resource: aws.ec2
  description: |
    Mark known user instances for deletion in 2 days
  filters:
    - "State.Name": running
    - type: value
      key: tag:Name
      op: regex
      value:  "^.*USERKEYS.*$"
    - 'tag:doNotDelete': absent
    - 'tag:DoNotDelete': absent
    - 'tag:ec2_unknown_user': absent
    - "tag:DeletesOnFriday": absent
    - "tag:ec2_known_user": absent
    - not: 
      - type: value
        key: tag:Name
        op: regex
        value:  "^.*DONOTDELETEKEYS.*$"
  actions:
    - type: mark-for-op
      tag: ec2_known_user
      op: terminate
      days: 2

- name: ec2-unmark-if-friday-tagged
  resource: aws.ec2
  description: |
    Remove the deletion tag from any resource group which now contain resources
    so it doesn't get deleted by the following policy
  filters:
    - or:
      - "tag:ec2_unknown_user": not-null
      - "tag:ec2_known_user": not-null
    - "tag:DeletesOnFriday": present
  actions:
    - type: remove-tag
      tags: ['ec2_unknown_user', 'ec2_known_user']

- name: ec2-terminate-instances
  resource: aws.ec2
  description: |
    Delete any marked instances which have been 
    marked for deletion for more than 1 day.
  filters:
    - or:
      - type: marked-for-op
        tag: ec2_unknown_user
        op: terminate
      - type: marked-for-op
        tag: ec2_known_user
        op: terminate
  actions:
    - type: terminate

# EKS Policies Disclaimer
# Note: cannot manage EKS nodegroups at this time, but the
# above ec2 policies should take care of any nodes

# There is a resource for eks-nodegroup in cloud custodian, 
# however there is no support for time delay nor tagging.

# EKS
- name: eks-mark-unknown-instances-for-deletion
  resource: aws.eks
  description: |
    Mark unknown user instances for deletion in 1 day
  filters:
    - type: value
      key: name
      op: regex
      #doesNOTcontain
      value:  "^((?!USERKEYS).)*$"
    # instance is not doNotDelete
    - 'tag:doNotDelete': absent
    - 'tag:DoNotDelete': absent
    - 'tag:ec2_known_user': absent
    - "tag:ec2_unknown_user": absent
    - "tag:DeletesOnFriday": absent
    - not: 
      - type: value
        key: name
        op: regex
        value:  "^.*DONOTDELETEKEYS.*$"
  actions:
    - type: mark-for-op
      tag: ec2_unknown_user
      op: delete
      days: 1

- name: eks-mark-known-instances-for-deletion
  resource: aws.eks
  description: |
    Mark known user instances for deletion in 2 days
  filters:
    - type: value
      key: name
      op: regex
      value:  "^.*USERKEYS.*$"
    - 'tag:doNotDelete': absent
    - 'tag:DoNotDelete': absent
    - 'tag:ec2_unknown_user': absent
    - "tag:ec2_known_user": absent
    - "tag:DeletesOnFriday": absent
    - not: 
      - type: value
        key: name
        op: regex
        value:  "^.*DONOTDELETEKEYS.*$"
  actions:
    - type: mark-for-op
      tag: ec2_known_user
      op: delete
      days: 2

- name: eks-unmark-if-friday-tagged
  resource: aws.eks
  description: |
    Remove the deletion tag from any resource group which now contain resources
    so it doesn't get deleted by the following policy
  filters:
    - or:
      - "tag:ec2_unknown_user": not-null
      - "tag:ec2_known_user": not-null
    - "tag:DeletesOnFriday": present
  actions:
    - type: remove-tag
      tags: ['ec2_unknown_user', 'ec2_known_user']

- name: eks-terminate-instances
  resource: aws.eks
  description: |
    Delete any marked instances which have been 
    marked for deletion for more than 1 day.
  filters:
    - or:
      - type: marked-for-op
        tag: ec2_unknown_user
        op: delete
      - type: marked-for-op
        tag: ec2_known_user
        op: delete
  actions:
    - type: delete

# NLBs
- name: mark-unknown-nlbs-for-deletion
  resource: app-elb
  filters:
    # nlb name not in accepted user keys
    - type: value
      key: LoadBalancerName
      op: regex
      #doesNOTcontain
      value:  "^((?!USERKEYS).)*$"
    # instance is not doNotDelete
    - 'tag:doNotDelete': absent
    - 'tag:DoNotDelete': absent
    - 'tag:ec2_known_user': absent
    - "tag:ec2_unknown_user": absent
    - "tag:DeletesOnFriday": absent
    - not: 
      - type: value
        key: LoadBalancerName
        op: regex
        value:  "^.*DONOTDELETEKEYS.*$"
  actions:
    - type: mark-for-op
      tag: ec2_unknown_user
      op: delete
      days: 1

- name: mark-known-nlbs-for-deletion
  resource: app-elb
  filters:
    # nlb is named with accepted user key
    - type: value
      key: LoadBalancerName
      op: regex
      value:  "^.*USERKEYS.*$"
    # nlb is not doNotDelete
    - 'tag:doNotDelete': absent
    - 'tag:DoNotDelete': absent
    - "tag:ec2_unknown_user": absent
    - "tag:ec2_known_user": absent
    - "tag:DeletesOnFriday": absent
    - not: 
      - type: value
        key: LoadBalancerName
        op: regex
        value:  "^.*DONOTDELETEKEYS.*$"
  actions:
    - type: mark-for-op
      tag: ec2_known_user
      op: delete
      days: 2

- name: nlb-unmark-if-friday-tagged
  resource: app-elb
  description: |
    Remove the deletion tag from any resource group which now contain resources
    so it doesn't get deleted by the following policy
  filters:
    - or:
      - "tag:ec2_unknown_user": not-null
      - "tag:ec2_known_user": not-null
    - "tag:DeletesOnFriday": present
  actions:
    - type: remove-tag
      tags: ['ec2_unknown_user', 'ec2_known_user']

- name: ec2-delete-nlbs
  resource: app-elb
  description: |
    Delete any marked nlbs which have been 
    marked for deletion for more than 1 day.
  filters:
    - or:
      - type: marked-for-op
        tag: ec2_unknown_user
        op: delete
      - type: marked-for-op
        tag: ec2_known_user
        op: delete
  actions:
    - type: delete

# Classic LBs
- name: mark-unknown-classic-nlbs-for-deletion
  resource: elb
  filters:
    # nlb name not in accepted user keys
    - type: value
      key: LoadBalancerName
      op: regex
      #doesNOTcontain
      value:  "^((?!USERKEYS).)*$"
    # instance is not doNotDelete
    - 'tag:doNotDelete': absent
    - 'tag:DoNotDelete': absent
    - 'tag:ec2_known_user': absent
    - "tag:ec2_unknown_user": absent
    - "tag:DeletesOnFriday": absent
    - not: 
      - type: value
        key: LoadBalancerName
        op: regex
        value:  "^.*DONOTDELETEKEYS.*$"
  actions:
    - type: mark-for-op
      tag: ec2_unknown_user
      op: delete
      days: 1

- name: mark-known-classc-nlbs-for-deletion
  resource: elb
  filters:
    # nlb is named with accepted user key
    - type: value
      key: LoadBalancerName
      op: regex
      value:  "^.*USERKEYS.*$"
    # nlb is not doNotDelete
    - 'tag:doNotDelete': absent
    - 'tag:DoNotDelete': absent
    - "tag:ec2_unknown_user": absent
    - "tag:ec2_known_user": absent
    - "tag:DeletesOnFriday": absent
    - not: 
      - type: value
        key: LoadBalancerName
        op: regex
        value:  "^.*DONOTDELETEKEYS.*$"
  actions:
    - type: mark-for-op
      tag: ec2_known_user
      op: delete
      days: 2

- name: classic-nlb-unmark-if-friday-tagged
  resource: elb
  description: |
    Remove the deletion tag from any resource group which now contain resources
    so it doesn't get deleted by the following policy
  filters:
    - or:
      - "tag:ec2_unknown_user": not-null
      - "tag:ec2_known_user": not-null
    - "tag:DeletesOnFriday": present
  actions:
    - type: remove-tag
      tags: ['ec2_unknown_user', 'ec2_known_user']

- name: ec2-delete-classic-nlbs
  resource: elb
  description: |
    Delete any marked nlbs which have been 
    marked for deletion for more than 1 day.
  filters:
    - or:
      - type: marked-for-op
        tag: ec2_unknown_user
        op: delete
      - type: marked-for-op
        tag: ec2_known_user
        op: delete
  actions:
    - type: delete

# key-pairs
- name: mark-unknown-unused-keypairs-for-deletion
  resource: aws.key-pair
  description: |
    Mark unknown user key-pairs for deletion in 1 day
  filters:
    # only show unused keys. note that aws won't let you delete used keys.
    - unused
    # instance name not in accepted user keys
    - type: value
      key: KeyName
      op: regex
      #doesNOTcontain
      value:  "^((?!USERKEYS).)*$"
    # instance is not doNotDelete
    - 'tag:doNotDelete': absent
    - 'tag:DoNotDelete': absent
    - 'tag:ec2_known_user': absent
    - "tag:DeletesOnFriday": absent
    - "tag:ec2_unknown_user": absent
    - not: 
      - type: value
        key: KeyName
        op: regex
        value:  "^.*DONOTDELETEKEYS.*$"
    - not: 
      - type: value
        key: KeyName
        op: regex
        value:  "^.*-validation.*$"
  actions:
    - type: mark-for-op
      tag: ec2_unknown_user
      op: delete
      days: 1

- name: mark-known-unused-keypairs-for-deletion
  resource: aws.key-pair
  description: |
    Mark unknown user key-pairs for deletion in 1 day
  filters:
    - unused
    - type: value
      key: KeyName
      op: regex
      value:  "^.*USERKEYS.*$"
    - 'tag:doNotDelete': absent
    - 'tag:DoNotDelete': absent
    - 'tag:ec2_unknown_user': absent
    - "tag:DeletesOnFriday": absent
    - "tag:ec2_known_user": absent
    - not: 
      - type: value
        key: KeyName
        op: regex
        value:  "^.*DONOTDELETEKEYS.*$"
    - not: 
      - type: value
        key: KeyName
        op: regex
        value:  "^.*-validation.*$"
  actions:
    - type: mark-for-op
      tag: ec2_known_user
      op: delete
      days: 2

- name: ec2-delete-keypairs
  resource: aws.key-pair
  description: |
    Delete any marked keypairs which have been 
    marked for deletion for more than 1 day.
  filters:
    - unused
    - or:
      - type: marked-for-op
        tag: ec2_unknown_user
        op: delete
      - type: marked-for-op
        tag: ec2_known_user
        op: delete
  actions:
    - type: delete

# Elastic IPs
- name: schedule-release-elasticip
  resource: network-addr
  filters:
    - type: value
      key: "length(Tags[?Key=='DoNotDelete'])"
      value: 0
      op: eq
    - type: value
      key: "length(Tags[?Key=='ec2_known_user'])"
      value: 0
      op: eq
  actions:
    - type: mark-for-op
      tag: ec2_known_user
      op: release
      # extending by 1 day to avoid deleting before associated resources are cleaned up
      days: 3

- name: release-expired-elasticip
  resource: network-addr
  description: |
    Delete any marked elasticips which have been 
    marked for deletion for more than 1 day.
  filters:
      - type: marked-for-op
        tag: ec2_known_user
        op: release
  actions:
    - type: release

# Target Groups
- name: schedule-delete-targetgroup
  resource: app-elb-target-group
  filters:
    - type: value
      key: "length(Tags[?Key=='DoNotDelete'])"
      value: 0
      op: eq
    - type: value
      key: "length(Tags[?Key=='ec2_known_user'])"
      value: 0
      op: eq
  actions:
    - type: mark-for-op
      tag: ec2_known_user
      op: delete
      # extending by 1 day to avoid deleting before associated resources are cleaned up
      days: 3
- name: ec2-delete-targetgrpup
  resource: app-elb-target-group
  description: |
    Delete any marked targetGroups which have been 
    marked for deletion for more than 1 day.
  filters:
      - type: marked-for-op
        tag: ec2_known_user
        op: delete
  actions:
    - type: delete